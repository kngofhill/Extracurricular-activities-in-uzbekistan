<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EC Platform Uzbekistan</title>
<!--Auth buttons-->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body { padding: 2rem; background-color: #f0f8ff; }
    .card { margin-top: 1rem; }
    .hide { display: none; }
    .card {
  border-radius: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
    #listings .card {
  margin-bottom: 1rem;
}
.modal-content {
  border-radius: 1rem;
  border: none;
}

  </style>
</head>
<body>
  <div class="container">
    <!--Auth buttons-->
<!--Auth buttons-->
<div class="d-flex justify-content-center gap-2 my-4">
  <button class="btn btn-outline-primary" onclick="showAuth('login')">Log In</button>
  <button class="btn btn-outline-secondary" onclick="showAuth('register')">Register</button>
  <button id="logoutBtn" class="btn btn-danger hide">Log Out</button>


</div>
    <h1 class="text-center">EC Platform Uzbekistan</h1>
<div class="d-flex justify-content-center justify-content-md-end mt-3 mb-3">
  <button id="postECBtn" class="btn btn-success px-4 py-2 rounded-pill shadow">I want to post</button>
</div>



<!-- Auth Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="authModalLabel">Log In or Register</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Login Form -->
        <form id="loginForm" style="display: none;">
          <div class="mb-3">
            <input type="email" class="form-control" id="loginEmail" placeholder="Email" required />
          </div>
          <div class="mb-3">
            <input type="password" class="form-control" id="loginPassword" placeholder="Password" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Log In</button>
          <p class="text-center mt-2">
            Don't have an account?
            <a href="#" onclick="showAuth('register')">Register</a>
          </p>
        </form>

        <!-- Register Form -->
        <form id="registerForm" style="display: none;">
          <div class="mb-3">
            <input type="email" class="form-control" id="registerEmail" placeholder="Email" required />
          </div>
          <div class="mb-3">
            <input type="password" class="form-control" id="registerPassword" placeholder="Password" required />
          </div>
          <button type="submit" class="btn btn-secondary w-100">Register</button>
          <p class="text-center mt-2">
            Already have an account?
            <a href="#" onclick="showAuth('login')">Log In</a>
          </p>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- Filter Section -->
<div id="filter-section" class="mt-4">
  <h3>Filter Listings</h3>
  <div class="d-flex flex-column flex-md-row gap-2">
    <select id="filter-location" class="form-control">
      <option value="">All Locations</option>
      <option>Andijan</option><option>Fergana</option><option>Tashkent</option>
      <option>Samarkand</option><option>Bukhara</option><option>Namangan</option>
      <option>Khorezm</option><option>Karakalpakstan</option><option>Jizzakh</option>
      <option>Kashkadarya</option><option>Surkhandarya</option><option>Syrdarya</option>
      <option>Navoi</option><option>Gulistan</option>
    </select>
    <select id="filter-field" class="form-control">
      <option value="">All Fields</option>
      <option>STEM</option><option>Business</option><option>Art</option>
      <option>Leadership</option><option>Debate</option><option>Writing</option>
    </select>
    <button id="filterBtn" class="btn btn-info">Filter</button>
  </div>
</div>


    <!-- Listings -->

<div id="listings" class="mt-3"></div>
  <div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5 class="modal-title" id="enrollModalLabel">Enter your Telegram details</h5>
      <input id="telegramUsername" class="form-control my-2" placeholder="Your Telegram username">
      <input id="telegramNumber" class="form-control my-2" placeholder="Your Telegram number">
      <button id="submitEnroll" class="btn btn-primary mt-2">Submit</button>
    </div>
  </div>
</div>
<!-- ðŸ”½ The form to create a listing (hidden by default) -->
<div id="createListingSection" class="mt-3" style="display: none;">
  <!-- Your form elements -->


    <select id="location" class="form-control">
      <option disabled selected>Choose location</option>
      <option>Andijan</option><option>Fergana</option><option>Tashkent</option>
      <option>Samarkand</option><option>Bukhara</option><option>Namangan</option>
      <option>Khorezm</option><option>Karakalpakstan</option><option>Jizzakh</option>
      <option>Kashkadarya</option><option>Surkhandarya</option><option>Syrdarya</option>
      <option>Navoi</option><option>Gulistan</option>
    </select>
    <select id="field" class="form-control mt-2">
      <option disabled selected>Choose field of EC</option>
      <option>STEM</option><option>Business</option><option>Art</option>
      <option>Leadership</option><option>Debate</option><option>Writing</option>
    </select>
    <select id="type" class="form-control mt-2">
      <option disabled selected>Choose type of EC</option>
      <option>Competition</option><option>Internship</option><option>Volunteering</option>
      <option>Online Course</option><option>Workshop</option><option>Club</option>
    </select>
    <input id="telegram" class="form-control mt-2" placeholder="Telegram Username (e.g. @myusername)" />
    <input id="title" class="form-control mt-2" placeholder="Title" />
    <textarea id="desc" class="form-control mt-2" placeholder="Description"></textarea>
    <button id="submitBtn" class="btn btn-warning mt-2">Post</button>
  </div>
</div>
<!-- modal for enrolling-->
<div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="enrollModalLabel">Enroll in Opportunity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="telegramUsername" class="form-control mb-2" placeholder="Your Telegram username">
        <input type="text" id="telegramNumber" class="form-control" placeholder="Your Telegram number">
        <input type="hidden" id="enrollListingId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="submitEnroll">Submit</button>
      </div>
    </div>
  </div>
</div>

    <!-- Toast Notification -->
    <div id="postToast" class="toast position-fixed bottom-0 end-0 end-md-0 start-md-auto m-3 align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          âœ… Post submitted successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  <!-- Auth Prompt Modal -->
<div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="loginPromptLabel">Authentication Required</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Please log in or register to post an opportunity.</p>
        <button class="btn btn-primary me-2" onclick="openAuthFromPrompt('login')">Log In</button>
        <button class="btn btn-secondary" onclick="openAuthFromPrompt('register')">Register</button>
      </div>
    </div>
  </div>
</div>

<!-- Enroll Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1" aria-labelledby="enrollModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="enrollForm">
        <div class="modal-header">
          <h5 class="modal-title" id="enrollModalLabel">Enroll in Opportunity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="telegramUsername" class="form-control mb-2" placeholder="Telegram username (e.g., @username)" required />
          <input type="text" id="telegramNumber" class="form-control" placeholder="Telegram number (e.g., +998...)" required />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="interestedUsersModal" tabindex="-1" aria-labelledby="interestedUsersModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="interestedUsersModalLabel">Interested Users</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="interestedUsersList" class="list-group"></ul>
      </div>
    </div>
  </div>
</div>


  

<script>
  function showAuth(type) {
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    if (type === "login") {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      document.getElementById("authModalLabel").innerText = "Log In";
    } else {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      document.getElementById("authModalLabel").innerText = "Register";
    }

    const modal = new bootstrap.Modal(document.getElementById("authModal"));
    modal.show();
  }

  function openAuthFromPrompt(type) {
    const promptModal = bootstrap.Modal.getInstance(document.getElementById("loginPromptModal"));
    promptModal.hide();
    showAuth(type);
  }
window.onload = function() {
function showAuth(type) {
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  if (type === "login") {
    loginForm.style.display = "block";
    registerForm.style.display = "none";
    document.getElementById("authModalLabel").innerText = "Log In";
  } else {
    loginForm.style.display = "none";
    registerForm.style.display = "block";
    document.getElementById("authModalLabel").innerText = "Register";
  }

  const modal = new bootstrap.Modal(document.getElementById("authModal"));
  modal.show();
}
function openAuthFromPrompt(type) {
  const promptModal = bootstrap.Modal.getInstance(document.getElementById("loginPromptModal"));
  promptModal.hide();
  showAuth(type);
}


function showCreateForm() {
  const user = auth.currentUser;
  if (!user) {
    const modal = new bootstrap.Modal(document.getElementById("loginPromptModal"));
    modal.show();
    return;
  }
  const section = document.getElementById("createListingSection");
  section.style.display = "block";
  section.scrollIntoView({ behavior: "smooth" });
}



  const firebaseConfig = {
    apiKey: "AIzaSyD__OINWiM7cLVx0pGsT3kBbZxrjBm23c0",
    authDomain: "extracurricularsuzbekistan.firebaseapp.com",
    databaseURL: "https://extracurricularsuzbekistan-default-rtdb.firebaseio.com",
    projectId: "extracurricularsuzbekistan",
    storageBucket: "extracurricularsuzbekistan.firebasestorage.app",
    messagingSenderId: "555521664728",
    appId: "1:555521664728:web:bf72cb8384be98ff7b99ad",
    measurementId: "G-Z53076ZBCJ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

// Auth fields inside the modal
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const registerEmail = document.getElementById('registerEmail');
  const registerPassword = document.getElementById('registerPassword');
  const logoutBtn = document.getElementById('logoutBtn');
  const submitBtn = document.getElementById('submitBtn');
  const filterBtn = document.getElementById('filterBtn');
  const filterSection = document.getElementById('filter-section');
  const listings = document.getElementById('listings');

  function showToast() {
    const toast = new bootstrap.Toast(document.getElementById("postToast"));
    toast.show();
  }

 

  // AUTH STATE LISTENER
const postECBtn = document.getElementById('postECBtn');

auth.onAuthStateChanged(user => {
  postECBtn.classList.remove('hide');

  if (user) {
    logoutBtn.classList.remove('hide');
  } else {
    logoutBtn.classList.add('hide');
  }

  // âœ… NOW we can safely load listings
  filterBtn.onclick();
});

postECBtn.onclick = showCreateForm;




  // SUBMIT POST
  submitBtn.onclick = () => {
    const loc = document.getElementById('location').value;
    const field = document.getElementById('field').value;
    const type = document.getElementById('type').value;
    const title = document.getElementById('title').value;
    const desc = document.getElementById('desc').value;
    const telegram = document.getElementById("telegram").value.trim();

    if (!title || !desc || !loc || !field || !type) return alert('Fill all fields');

    const newPostRef = db.ref('posts').push();
    newPostRef.set({
      title,
      desc,
      location: loc,
      field,
      type,
      telegram,
      uid: auth.currentUser.uid
    }).then(() => {
      showToast();
      document.getElementById("createListingSection").style.display = "none"; 
      document.getElementById('title').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('telegram').value = '';
      document.getElementById('location').selectedIndex = 0;
      document.getElementById('field').selectedIndex = 0;
      document.getElementById('type').selectedIndex = 0;

      listings.scrollIntoView({ behavior: 'smooth' });

    }).catch(err => {
      alert("Failed to post: " + err.message);
    });
  };

  // FILTER POSTS
  filterBtn.onclick = () => {
    if ((fLoc === '' || post.location === fLoc) && (fField === '' || post.field === fField)) {
  found = true;

  let html = `
    <div class="card">
      <div class="card-body">
        <h5>${post.title}</h5>
        <p>${post.desc}</p>
        <p><strong>${post.field}</strong> - ${post.type}, ${post.location}</p>
        <p><strong>Telegram:</strong> ${post.telegram || "N/A"}</p>
        <button class="btn btn-outline-primary enroll-btn" data-id="${child.key}">Enroll</button>
  `;

  if (auth.currentUser && post.uid === auth.currentUser.uid) {
    html += `<button class="btn btn-info mt-2 show-interested-btn" data-id="${child.key}">Show Interested Users</button>`;
  }

  html += `</div></div>`;
  listings.innerHTML += html;
}
    const fLoc = document.getElementById('filter-location').value;
    const fField = document.getElementById('filter-field').value;

    db.ref('posts').once('value', snapshot => {
      listings.innerHTML = '';
      let found = false;
      snapshot.forEach(child => {
        const post = child.val();
        if ((fLoc === '' || post.location === fLoc) && (fField === '' || post.field === fField)) {
          found = true;
          listings.innerHTML += `
            <div class="card">
              <div class="card-body">
                <h5>${post.title}</h5>
                <p>${post.desc}</p>
                <p><strong>${post.field}</strong> - ${post.type}, ${post.location}</p>
                <p><strong>Telegram:</strong> ${post.telegram || "N/A"}</p>
              </div>
            </div>`;
        }
      });
      if (!found) {
        listings.innerHTML = `<p class="text-muted mt-3">No opportunities match your filters. Please try again later.</p>`;
      }
    });
  };
  // REGISTER
// REGISTER
document.getElementById("registerForm").onsubmit = (e) => {
  e.preventDefault();
  auth.createUserWithEmailAndPassword(registerEmail.value, registerPassword.value)
    .then(() => {
      alert('Registered successfully');
      bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();
    })
    .catch(e => alert(e.message));
};
 // Reload unfiltered listings

// LOGIN
document.getElementById("loginForm").onsubmit = (e) => {
  e.preventDefault();
  auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
    .then(() => {
      alert('Signed in successfully');

      // âœ… Close the modal
      bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();

      // âœ… Scroll to "Post" button after successful login
      document.getElementById("postECBtn").scrollIntoView({ behavior: "smooth" });
    })
    .catch(e => alert(e.message));
};
  filterBtn.onclick(); // Reload unfiltered listings
  logoutBtn.onclick = () => {
  auth.signOut().then(() => {
    alert('Logged out');
    listings.innerHTML = ''; // Clear listings on logout
      // Optionally refresh with empty listings
  });
};
 let currentListingId = null;

  // Show modal on enroll button click
  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("enroll-btn")) {
      currentListingId = e.target.dataset.id;
      const modal = new bootstrap.Modal(document.getElementById('enrollModal'));
      modal.show();
    }
  });

  // Submit enrollment
  document.getElementById("submitEnroll").addEventListener("click", async () => {
    const username = document.getElementById("telegramUsername").value.trim();
    const number = document.getElementById("telegramNumber").value.trim();

    if (!username || !number) {
      alert("Please fill in both fields.");
      return;
    }

    // Save to subcollection 'enrollments' under listing doc
db.ref(`enrollments/${currentListingId}`).push({
  username,
  number,
  enrolledAt: Date.now(),
});


    alert("Youâ€™ve been enrolled!");
    bootstrap.Modal.getInstance(document.getElementById("enrollModal")).hide();

    // Clear inputs
    document.getElementById("telegramUsername").value = '';
    document.getElementById("telegramNumber").value = '';
  });
  document.addEventListener("click", function(e) {
  if (e.target.classList.contains("show-interested-btn")) {
    const listingId = e.target.dataset.id;
    db.ref(`enrollments/${listingId}`).once('value', snap => {
      if (!snap.exists()) return alert("No one has enrolled yet.");

      let info = "Interested Users:\n\n";
      snap.forEach(child => {
        const data = child.val();
        info += `ðŸ‘¤ ${data.username} | ðŸ“ž ${data.number}\n`;
      });

      alert(info);
    });
  }
});


}
  document.addEventListener("click", function(e) {
  if (e.target.classList.contains("enroll-btn")) {
    const listingId = e.target.dataset.id;
    document.getElementById("enrollListingId").value = listingId;
    new bootstrap.Modal(document.getElementById("enrollModal")).show();
  }
});

document.getElementById("submitEnroll").addEventListener("click", () => {
  const username = document.getElementById("telegramUsername").value.trim();
  const number = document.getElementById("telegramNumber").value.trim();
  const listingId = document.getElementById("enrollListingId").value;

  if (!username || !number) {
    alert("Please fill in all fields.");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("Please log in to enroll.");
    return;
  }

  const enrollRef = db.collection("listings").doc(listingId).collection("interestedUsers");

  enrollRef.doc(user.uid).set({
    telegramUsername: username,
    telegramNumber: number,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert("Enrolled successfully!");
    bootstrap.Modal.getInstance(document.getElementById("enrollModal")).hide();
  }).catch(error => {
    console.error("Enrollment error:", error);
    alert("Failed to enroll. Please try again.");
  });
});

  if (!title || !desc || !loc || !field || !type) {
  alert('Fill all fields'); // Replace with inline error later
  return;
}
  let selectedListingId = null;

document.addEventListener("click", (e) => {
  if (e.target.classList.contains("enroll-btn")) {
    selectedListingId = e.target.dataset.id;
    new bootstrap.Modal(document.getElementById("enrollModal")).show();
  }
});

document.getElementById("enrollForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("telegramUsername").value.trim();
  const number = document.getElementById("telegramNumber").value.trim();
  const user = auth.currentUser;

  if (!user) {
    alert("You must be logged in to enroll.");
    return;
  }

  try {
    await db.collection("listings")
      .doc(selectedListingId)
      .collection("interestedUsers")
      .doc(user.uid)
      .set({
        username,
        number,
        userId: user.uid,
        email: user.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    bootstrap.Modal.getInstance(document.getElementById("enrollModal")).hide();
    alert("Enrollment submitted!");
  } catch (err) {
    console.error("Enrollment error:", err);
    alert("Failed to enroll. Please try again.");
  }
});
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("show-users-btn")) {
    const listingId = e.target.dataset.id;
    const usersList = document.getElementById("interestedUsersList");
    usersList.innerHTML = "<li class='list-group-item'>Loading...</li>";

    const usersSnapshot = await db.collection("listings")
      .doc(listingId)
      .collection("interestedUsers")
      .orderBy("timestamp", "desc")
      .get();

    usersList.innerHTML = "";

    if (usersSnapshot.empty) {
      usersList.innerHTML = "<li class='list-group-item'>No one has enrolled yet.</li>";
    } else {
      usersSnapshot.forEach(doc => {
        const user = doc.data();
        usersList.innerHTML += `
          <li class="list-group-item">
            <strong>@${user.username}</strong><br>
            ðŸ“ž ${user.number}<br>
            ðŸ“§ ${user.email}
          </li>
        `;
      });
    }

    new bootstrap.Modal(document.getElementById("interestedUsersModal")).show();
  }
});

  filterBtn.onclick();


</script>

</body>
</html>






