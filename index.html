<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EC Connect Uzbekistan | Find Amazing Opportunities</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary: #6a11cb;
      --secondary: #2575fc;
      --accent: #ff4d4d;
      --light: #f8f9fa;
      --dark: #212529;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    
    .hero-section {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border-radius: 15px;
      padding: 3rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .card-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
    }
    
    .btn-primary {
      background: var(--primary);
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 50px;
      font-weight: 600;
    }
    
    .btn-primary:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: #28a745;
      border: none;
      padding: 0.6rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
    }
    
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-outline-primary:hover {
      background: var(--primary);
    }
    
    .category-badge {
      display: inline-block;
      padding: 0.35rem 0.65rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .STEM { background: rgba(106, 17, 203, 0.1); color: var(--primary); }
    .Business { background: rgba(37, 117, 252, 0.1); color: #2575fc; }
    .Art { background: rgba(255, 77, 77, 0.1); color: var(--accent); }
    .Leadership { background: rgba(40, 167, 69, 0.1); color: #28a745; }
    .Debate { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
    .Writing { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    
    .enroll-btn {
      background: var(--accent);
      border: none;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .enroll-btn:hover {
      background: #ff3333;
      transform: scale(1.05);
    }
    
    .hide { display: none; }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .feature-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Hero Section -->
    <div class="hero-section text-center">
      <h1 class="display-4 fw-bold mb-3">ðŸš€ EC Connect Uzbekistan</h1>
      <p class="lead mb-4">Discover amazing extracurricular opportunities to boost your skills and university applications!</p>
      <div class="d-flex justify-content-center gap-3">
        <button class="btn btn-light btn-lg pulse-animation" onclick="showAuth('register')">
          <i class="bi bi-rocket-takeoff"></i> Get Started
        </button>
        <button id="postECBtn" class="btn btn-outline-light btn-lg">
          <i class="bi bi-plus-circle"></i> Post Opportunity
        </button>
      </div>
    </div>

    <!-- Auth Buttons (for logged out state) -->
    <div id="authButtons" class="d-flex justify-content-center gap-2 my-4 hide">
      <button class="btn btn-outline-primary" onclick="showAuth('login')">
        <i class="bi bi-box-arrow-in-right"></i> Log In
      </button>
      <button class="btn btn-outline-secondary" onclick="showAuth('register')">
        <i class="bi bi-person-plus"></i> Register
      </button>
    </div>

    <!-- User Controls (for logged in state) -->
    <div id="userControls" class="d-flex justify-content-end gap-2 my-4 hide">
      <button id="logoutBtn" class="btn btn-danger">
        <i class="bi bi-box-arrow-left"></i> Log Out
      </button>
    </div>

    <!-- Features Grid -->
    <div class="row text-center mb-5">
      <div class="col-md-4 mb-4">
        <div class="p-4 bg-white rounded-3 h-100">
          <i class="bi bi-trophy feature-icon floating"></i>
          <h3>Boost Your Profile</h3>
          <p>Find competitions and programs that make your university applications stand out</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="p-4 bg-white rounded-3 h-100">
          <i class="bi bi-people feature-icon floating"></i>
          <h3>Build Connections</h3>
          <p>Connect with like-minded students across Uzbekistan</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="p-4 bg-white rounded-3 h-100">
          <i class="bi bi-lightbulb feature-icon floating"></i>
          <h3>Discover Passions</h3>
          <p>Explore new fields and find what truly excites you</p>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div id="filter-section" class="mt-4 bg-white p-4 rounded-3 shadow-sm">
      <h3 class="mb-3"><i class="bi bi-funnel"></i> Find Your Perfect Opportunity</h3>
      <div class="filter-buttons mb-3">
        <button id="showAllBtn" class="btn btn-outline-primary">All Opportunities</button>
        <button id="showMyPostsBtn" class="btn btn-outline-secondary hide">My Posts</button>
        <button id="showMyEnrollmentsBtn" class="btn btn-outline-info hide">My Enrollments</button>
      </div>
      <div class="d-flex flex-column flex-md-row gap-2">
        <select id="filter-location" class="form-select">
          <option value="">All Locations</option>
          <option>Tashkent</option>
          <option>Samarkand</option>
          <option>Bukhara</option>
          <!-- Other locations -->
        </select>
        <select id="filter-field" class="form-select">
          <option value="">All Fields</option>
          <option>STEM</option>
          <option>Business</option>
          <option>Art</option>
          <!-- Other fields -->
        </select>
        <button id="filterBtn" class="btn btn-primary">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
    </div>

    <!-- Listings -->
    <div id="listings" class="mt-4"></div>

    <!-- Create Listing Form -->
    <div id="createListingSection" class="mt-4 bg-white p-4 rounded-3 shadow-sm" style="display: none;">
      <h3 class="mb-3"><i class="bi bi-plus-circle"></i> Create New Opportunity</h3>
      <!-- Form fields remain the same -->
    </div>

    <!-- All modals remain the same but now with better styling -->
    
    <!-- View Enrollments Modal (updated) -->
    <div class="modal fade" id="viewEnrollmentsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="bi bi-people-fill"></i> Participants</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="enrolledUsersList" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading participants...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
    function updateUI(user) {
      if (user) {
        document.getElementById('authButtons').classList.add('hide');
        document.getElementById('userControls').classList.remove('hide');
        document.getElementById('postECBtn').textContent = 'Post Opportunity';
        document.getElementById('showMyPostsBtn').classList.remove('hide');
        document.getElementById('showMyEnrollmentsBtn').classList.remove('hide');
      } else {
        document.getElementById('authButtons').classList.remove('hide');
        document.getElementById('userControls').classList.add('hide');
        document.getElementById('postECBtn').textContent = 'Post Opportunity (Login Required)';
        document.getElementById('showMyPostsBtn').classList.add('hide');
        document.getElementById('showMyEnrollmentsBtn').classList.add('hide');
      }
      loadListings(currentFilter);
    }
      // Firebase Configuration and Initialization
      const firebaseConfig = {
        apiKey: "AIzaSyD__OINWiM7cLVx0pGsT3kBbZxrjBm23c0",
        authDomain: "extracurricularsuzbekistan.firebaseapp.com",
        databaseURL: "https://extracurricularsuzbekistan-default-rtdb.firebaseio.com",
        projectId: "extracurricularsuzbekistan",
        storageBucket: "extracurricularsuzbekistan.firebasestorage.app",
        messagingSenderId: "555521664728",
        appId: "1:555521664728:web:bf72cb8384be98ff7b99ad",
        measurementId: "G-Z53076ZBCJ"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // DOM Elements
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const logoutBtn = document.getElementById("logoutBtn");
      const postECBtn = document.getElementById("postECBtn");
      const submitBtn = document.getElementById("submitBtn");
      const filterBtn = document.getElementById("filterBtn");
      const showAllBtn = document.getElementById("showAllBtn");
      const showMyPostsBtn = document.getElementById("showMyPostsBtn");
      const showMyEnrollmentsBtn = document.getElementById("showMyEnrollmentsBtn");
      const listings = document.getElementById("listings");

      // Current filter state
      let currentFilter = "all"; // 'all', 'myPosts', 'myEnrollments'

      // Show Auth Modal Function
      window.showAuth = function(type) {
        if (type === "login") {
          loginForm.style.display = "block";
          registerForm.style.display = "none";
          document.getElementById("authModalLabel").innerText = "Log In";
        } else {
          loginForm.style.display = "none";
          registerForm.style.display = "block";
          document.getElementById("authModalLabel").innerText = "Register";
        }
        new bootstrap.Modal(document.getElementById("authModal")).show();
      };

      // Open Auth From Prompt
      window.openAuthFromPrompt = function(type) {
        bootstrap.Modal.getInstance(document.getElementById("loginPromptModal")).hide();
        showAuth(type);
      };

      // Show Create Form Function
      function showCreateForm() {
        const user = auth.currentUser;
        if (!user) {
          new bootstrap.Modal(document.getElementById("loginPromptModal")).show();
          return;
        }
        const section = document.getElementById("createListingSection");
        section.style.display = "block";
        section.scrollIntoView({ behavior: "smooth" });
      }

      // Show Toast Notification
      function showToast() {
        new bootstrap.Toast(document.getElementById("postToast")).show();
      }

      // Auth State Listener
        auth.onAuthStateChanged(user => {
        updateUI(user);
        
        // Additional check for enrollments modal
        const enrollModal = bootstrap.Modal.getInstance(document.getElementById("enrollModal"));
        if (!user && enrollModal) {
          enrollModal.hide();
        }
      });
        loginForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            // No need to manually refresh - auth state listener will handle it
          })
          .catch(error => {
            let errorMessage = "Login failed. ";
            if (error.code === "auth/wrong-password" || error.code === "auth/user-not-found") {
              errorMessage += "Invalid email or password.";
            } else {
              errorMessage += error.message;
            }
            alert(errorMessage);
          });
      });

      // Register Form Submission
      registerForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        
        auth.createUserWithEmailAndPassword(email, password)
          .then(() => {
            alert("Registered successfully!");
            bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();
          })
          .catch(error => alert(error.message));
      });

      // Logout Function
     logoutBtn.addEventListener("click", function() {
        auth.signOut()
          .then(() => {
            // No alert needed - changes will be visible immediately
            currentFilter = "all";
            // No need to manually clear listings - auth state listener will handle it
          })
          .catch(error => console.error("Logout error:", error));
      });


      // Post EC Button
      postECBtn.addEventListener("click", showCreateForm);

      // Submit Listing
      submitBtn.addEventListener("click", function() {
        const title = document.getElementById("title").value.trim();
        const desc = document.getElementById("desc").value.trim();
        const loc = document.getElementById("location").value;
        const field = document.getElementById("field").value;
        const type = document.getElementById("type").value;
        const telegram = document.getElementById("telegram").value.trim();

        if (!title || !desc || !loc || !field || !type) {
          alert("Please fill in all required fields.");
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          alert("Please log in to post.");
          return;
        }

        db.ref("posts").push({
          title,
          desc,
          location: loc,
          field,
          type,
          telegram,
          uid: user.uid,
          timestamp: Date.now()
        })
        .then(() => {
          showToast();
          document.getElementById("createListingSection").style.display = "none";
          ["title", "desc", "telegram"].forEach(id => document.getElementById(id).value = "");
          ["location", "field", "type"].forEach(id => document.getElementById(id).selectedIndex = 0);
          filterBtn.click();
        })
        .catch(err => alert("Error submitting post: " + err.message));
      });

      // Filter Listings
      function loadListings(filterType = "all") {
        const fLoc = document.getElementById("filter-location").value;
        const fField = document.getElementById("filter-field").value;
        const user = auth.currentUser;

        db.ref("posts").once("value").then(snapshot => {
          listings.innerHTML = "";
          let found = false;
          
          snapshot.forEach(child => {
            const post = child.val();
            const postId = child.key;
            
            // Apply filters based on filterType
            let showPost = true;
            if (filterType === "myPosts" && (!user || user.uid !== post.uid)) {
              showPost = false;
            }
            
            if (showPost && (!fLoc || post.location === fLoc) && (!fField || post.field === fField)) {
              found = true;
              
              // Check if current user is the post owner
              const isOwner = user && user.uid === post.uid;
              
              let enrollmentsSection = '';
              if (isOwner) {
                enrollmentsSection = `
                  <div class="enrolled-users">
                    <button class="btn btn-sm btn-info view-enrollments" data-post-id="${postId}">
                      View Enrollments
                    </button>
                    <div id="enrollments-${postId}" class="mt-2"></div>
                  </div>
                `;
              }
              
          listings.innerHTML += `
  <div class="card mt-2" data-post-id="${postId}">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <h5 class="card-title">${post.title}</h5>
        <div>
          <span class="category-badge ${post.field}">${post.field}</span>
          <span class="category-badge ${post.type.replace(' ', '')}">${post.type}</span>
        </div>
      </div>
      <p class="card-text text-muted">${post.desc}</p>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="badge bg-light text-dark me-2">
            <i class="bi bi-geo-alt"></i> ${post.location}
          </span>
          <span class="badge bg-light text-dark">
            <i class="bi bi-telegram"></i> ${post.telegram || "Contact"}
          </span>
        </div>
        <button class="btn btn-primary enroll-btn" data-post-id="${postId}">
          <i class="bi bi-arrow-right-circle"></i> Enroll Now
        </button>
      </div>
      ${enrollmentsSection}
    </div>
  </div>
`;
            }
          });

          if (!found) {
            listings.innerHTML = `<p class="text-muted mt-3">No opportunities match your filters.</p>`;
          } else {
            // Add event listeners to all enroll buttons
            document.querySelectorAll(".enroll-btn").forEach(btn => {
              btn.addEventListener("click", function() {
                const postId = this.getAttribute("data-post-id");
                if (!auth.currentUser) {
                  alert("Please register or log in to enroll.");
                  showAuth('login');
                  return;
                }
                document.getElementById("enrollPostId").value = postId;
                new bootstrap.Modal(document.getElementById("enrollModal")).show();
              });
            });

            // Add event listeners to view enrollments buttons
            document.querySelectorAll(".view-enrollments").forEach(btn => {
              btn.addEventListener("click", function() {
                const postId = this.getAttribute("data-post-id");
                viewEnrollments(postId);
              });
            });
          }
        }).catch(error => {
          console.error("Error fetching posts:", error);
          listings.innerHTML = `<p class="text-danger mt-3">Failed to load opportunities.</p>`;
        });
      }

      // Filter button click handler
      filterBtn.addEventListener("click", function() {
        loadListings(currentFilter);
      });

      // Show All button
      showAllBtn.addEventListener("click", function() {
        currentFilter = "all";
        loadListings();
      });

      // Show My Posts button
      showMyPostsBtn.addEventListener("click", function() {
        currentFilter = "myPosts";
        loadListings("myPosts");
      });

      // Show My Enrollments button
      showMyEnrollmentsBtn.addEventListener("click", function() {
        const user = auth.currentUser;
        if (!user) {
          alert("Please log in to view your enrollments.");
          return;
        }
        
        db.ref("enrollments").once("value").then(snapshot => {
          const enrolledPostIds = [];
          snapshot.forEach(postSnapshot => {
            if (postSnapshot.hasChild(user.uid)) {
              enrolledPostIds.push(postSnapshot.key);
            }
          });
          
          if (enrolledPostIds.length === 0) {
            listings.innerHTML = `<p class="text-muted mt-3">You haven't enrolled in any opportunities yet.</p>`;
            return;
          }
          
          // Now fetch and display only the posts the user has enrolled in
          db.ref("posts").once("value").then(postsSnapshot => {
            listings.innerHTML = "";
            let found = false;
            
            postsSnapshot.forEach(postChild => {
              const post = postChild.val();
              const postId = postChild.key;
              
              if (enrolledPostIds.includes(postId)) {
                found = true;
                listings.innerHTML += `
                  <div class="card mt-2" data-post-id="${postId}">
                    <div class="card-body">
                      <h5>${post.title}</h5>
                      <p>${post.desc}</p>
                      <p><strong>${post.field}</strong> - ${post.type}, ${post.location}</p>
                      <p><strong>Telegram:</strong> ${post.telegram || "N/A"}</p>
                    </div>
                  </div>
                `;
              }
            });
            
            if (!found) {
              listings.innerHTML = `<p class="text-muted mt-3">No enrolled opportunities found.</p>`;
            }
          });
        });
      });

      // Enroll Form Submission
      document.getElementById("enrollForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const postId = document.getElementById("enrollPostId").value;
        const telegram = document.getElementById("enrollTelegram").value.trim();
        const phone = document.getElementById("enrollPhone").value.trim();
        const user = auth.currentUser;

        if (!user) {
          alert("Please log in to enroll.");
          return;
        }

        const enrollmentData = {
          userId: user.uid,
          userEmail: user.email,
          telegram,
          phone,
          timestamp: Date.now()
        };

        db.ref(`enrollments/${postId}/${user.uid}`).set(enrollmentData)
          .then(() => {
            alert("Enrollment successful!");
            bootstrap.Modal.getInstance(document.getElementById("enrollModal")).hide();
            document.getElementById("enrollForm").reset();
            loadListings(currentFilter); // Refresh listings with current filter
          })
          .catch(error => alert("Enrollment error: " + error.message));
      });

      // Function to view enrollments
      function viewEnrollments(postId) {
        const enrolledUsersList = document.getElementById("enrolledUsersList");
        enrolledUsersList.innerHTML = `
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading enrollments...</p>
          </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById("viewEnrollmentsModal"));
        modal.show();
        
        db.ref(`enrollments/${postId}`).once("value").then(snapshot => {
          if (!snapshot.exists() || snapshot.numChildren() === 0) {
            enrolledUsersList.innerHTML = `
              <div class="text-center py-4">
                <i class="bi bi-people fs-1 text-muted"></i>
                <h5>No enrollments yet</h5>
                <p class="text-muted">No one has enrolled in this opportunity yet.</p>
              </div>
            `;
            return;
          }
          
          let html = '<div class="list-group">';
          snapshot.forEach(child => {
            const enrollment = child.val();
            html += `
              <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${enrollment.userEmail}</h6>
                  <small>${new Date(enrollment.timestamp).toLocaleString()}</small>
                </div>
                <p class="mb-1">Telegram: ${enrollment.telegram}</p>
                <small>Phone: ${enrollment.phone}</small>
              </div>
            `;
          });
          html += '</div>';
          enrolledUsersList.innerHTML = html;
          
        }).catch(error => {
          enrolledUsersList.innerHTML = `
            <div class="alert alert-danger">
              Error loading enrollments: ${error.message}
            </div>
          `;
        });
      }

      // Initial load of listings
      loadListings();
    });
  </script>
</body>
</html>
